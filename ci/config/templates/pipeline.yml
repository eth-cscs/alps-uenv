stages:
  - build
  - test


.base-build:
  stage: build
  variables:
    SLURM_TIMELIMIT: 180
  script:
  - ./stack-build -n $STACK_NAME -s $STACK_SYSTEM -r $STACK_RECIPE -b /dev/shm/jenkssl $SPACK_DEVELOP -m $STACK_MOUNT -u $STACK_UARCH
  after_script:
  - rm -Rf /dev/shm/jenkssl

.base-test:
  stage: test
  variables:
    SLURM_TIMELIMIT: 30
    GIT_STRATEGY: fetch
  script:
  - ./run-reframe -n $STACK_NAME -s $STACK_SYSTEM -m $STACK_MOUNT -u $STACK_UARCH


{% for job in jobs %}

build-{{job.uenv}}/{{job.version}}-{{job.system}}/{{job.uarch}}:
  extends: .base-build
  tags: ["{{job.slurm_runner}}"]
  variables:
    STACK_MOUNT:      "{{job.mount}}"
    SPACK_DEVELOP:    "{{job.spack_develop}}"
    STACK_NAME:       "{{job.uenv}}/{{job.version}}"
    STACK_SYSTEM:     "{{job.system}}"
    SLURM_PARTITION:  "{{job.partition}}"
    STACK_RECIPE:     "{{job.recipe_path}}"
    STACK_UARCH:      "{{job.uarch}}"

test-{{job.uenv}}/{{job.version}}-{{job.system}}/{{job.uarch}}:
  extends: .base-test
  tags: ["{{job.baremetal_runner}}"]
  needs: ["build-{{job.uenv}}/{{job.version}}-{{job.system}}/{{job.uarch}}"]
  variables:
    STACK_NAME:       "{{job.uenv}}/{{job.version}}"
    STACK_SYSTEM:     "{{job.system}}"
    STACK_UARCH:      "{{job.uarch}}"
    STACK_MOUNT:      "{{job.mount}}"
    SLURM_PARTITION:  "{{job.partition}}"

{% endfor %}

