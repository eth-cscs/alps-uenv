#!/bin/bash

set -e

function SECTION() {
  echo ""
  echo "-------------------------------------"
  echo "-- $1"
  echo "-------------------------------------"
}

# =====================================
SECTION "environment variables"
printenv

# =====================================
SECTION "set vars we need frequently"
RECIPE_BUILD={{ env.build }}
RECIPE=${RECIPE_BUILD}/store/meta/recipe
UENV_STORE={{ env.mount }}
SPACK_CMD="spack -C {{ env.config }}"

# =====================================
SECTION "source spack environment setup"
SPACK_ROOT=$( $SPACK_CMD location -r )
source $SPACK_ROOT/share/spack/setup-env.sh

# =====================================
SECTION "convert stackinator environment into a package"

# SPACK_ENV_NAME should match the name of the uenv environment, because it maps to the underlying spack environment
SPACK_ENV_NAME="paraview-osmesa"
python3 $RECIPE/scripts/env-to-package.py -f $RECIPE/environments.yaml -p $SPACK_ENV_NAME --add

# SPEC is the name of the package generated by env-to-package.py
SPEC=$SPACK_ENV_NAME

# =====================================
SECTION "create and activate build-env"
BUILD_ENV_DEV=$UENV_STORE/paraview-buildenv-dev.rc
$SPACK_CMD -e ${RECIPE_BUILD}/environments/$SPACK_ENV_NAME/ add $SPEC
$SPACK_CMD -e ${RECIPE_BUILD}/environments/$SPACK_ENV_NAME/ concretize
$SPACK_CMD -e ${RECIPE_BUILD}/environments/$SPACK_ENV_NAME/ build-env --dump $BUILD_ENV_DEV $SPEC
source $BUILD_ENV_DEV
rm $BUILD_ENV_DEV

# =====================================
SECTION "download paraview sources..."
SRC_ROOT=$UENV_STORE/temp/src
BUILD_ROOT=$UENV_STORE/temp/build

PARAVIEW_TAG="v6.1.0-RC1"

PARAVIEW_SRC_DIR=$SRC_ROOT/paraview-src
PARAVIEW_BUILD_DIR=$BUILD_ROOT/paraview
PARAVIEW_INSTALL_DIR=$UENV_STORE/paraview
PARAVIEW_PLUGINS_DIR=$UENV_STORE/paraview-plugins

mkdir -p $SRC_ROOT
mkdir -p $BUILD_ROOT
mkdir -p $PARAVIEW_INSTALL_DIR
mkdir -p $PARAVIEW_PLUGINS_DIR

git clone --branch ${PARAVIEW_TAG} --depth 1 https://gitlab.kitware.com/paraview/paraview.git ${PARAVIEW_SRC_DIR}
pushd ${PARAVIEW_SRC_DIR}
git submodule update --init --recursive
popd

# NOTE: a proper fix has been merged in master but it is not part of v6.1.0-RC1
echo "Patching VTK::hdf5 CMake target problem..."
pushd $PARAVIEW_SRC_DIR
git grep -lr --recurse-submodules "VTK::hdf5" | xargs sed -i "s/VTK::hdf5/VTK::vtkhdf5/g"
popd

echo "Patching VTK with external Viskores CMake targets problem..."
patch -p 1 -d $PARAVIEW_SRC_DIR/VTK <<-'EOF'
  diff --git a/ThirdParty/viskores/CMakeLists.txt b/ThirdParty/viskores/CMakeLists.txt
  index 468932c21a..917aef03bf 100644
  --- a/ThirdParty/viskores/CMakeLists.txt
  +++ b/ThirdParty/viskores/CMakeLists.txt
  @@ -30,4 +30,11 @@ vtk_module_third_party(

   if(VTK_MODULE_USE_EXTERNAL_vtkviskores)
     viskores_setup_job_pool()
  +
  +  get_property(
  +    _targets_list
  +    DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
  +    PROPERTY IMPORTED_TARGETS)
  +
  +  set_target_properties(${_targets_list} PROPERTIES IMPORTED_GLOBAL TRUE)
   endif()
EOF

# =====================================
SECTION "configure paraview build..."

cmake                                                       \
    -DCMAKE_BUILD_TYPE=Release                              \
    -DPARAVIEW_BUILD_EDITION=CANONICAL                      \
    -DPARAVIEW_BUILD_TESTING=OFF                            \
    -DPARAVIEW_BUILD_WITH_EXTERNAL=ON                       \
    -DPARAVIEW_INSTALL_DEVELOPMENT_FILES=ON                 \
    -DPARAVIEW_RELOCATABLE_INSTALL=OFF                      \
    -DPARAVIEW_VERSIONED_INSTALL=OFF                        \
    -DPARAVIEW_USE_CUDA=OFF                                 \
    -DPARAVIEW_USE_MPI=ON                                   \
    -DPARAVIEW_USE_PYTHON=ON                                \
    -DPARAVIEW_USE_QT=OFF                                   \
    -DPARAVIEW_USE_VISKORES=ON                              \
    -DPARAVIEW_ENABLE_RAYTRACING:BOOL=ON                    \
    -DPARAVIEW_ENABLE_CATALYST=ON                           \
    -DPARAVIEW_ENABLE_WEB:BOOL=OFF                          \
    -DPARAVIEW_ENABLE_ADIOS2=ON                             \
    -DPARAVIEW_ENABLE_FIDES:BOOL=ON                         \
    -DPARAVIEW_ENABLE_VISITBRIDGE:BOOL=ON                   \
    -DPARAVIEW_PLUGIN_ENABLE_CDIReader=ON                   \
    -DPARAVIEW_PLUGIN_ENABLE_NetCDFTimeAnnotationPlugin=ON  \
    -DPARAVIEW_PLUGIN_ENABLE_pvNVIDIAIndeX=OFF              \
    `# VTK options`                                         \
    -DVTK_USE_X=OFF                                         \
    -DVTK_USE_Wayland=OFF                                   \
    -DVTK_OPENGL_HAS_OSMESA=ON                              \
    -DVTK_SMP_IMPLEMENTATION_TYPE=TBB                       \
    -DVTK_MODULE_USE_EXTERNAL_VTK_scn=OFF                   \
    -DVTK_MODULE_USE_EXTERNAL_VTK_fast_float=OFF            \
    -DVTK_MODULE_USE_EXTERNAL_VTK_token=OFF                 \
    -DVTK_MODULE_USE_EXTERNAL_VTK_exprtk=OFF                \
    -DVTK_MODULE_USE_EXTERNAL_VTK_vtkviskores=ON            \
    -DVTKOSPRAY_ENABLE_DENOISER:BOOL=ON                     \
    -S $PARAVIEW_SRC_DIR                                    \
    -B $PARAVIEW_BUILD_DIR                                  \
    --install-prefix $PARAVIEW_INSTALL_DIR                  \
    -G Ninja

# =====================================
SECTION "build and install paraview"
cmake --build $PARAVIEW_BUILD_DIR -j
cmake --install $PARAVIEW_BUILD_DIR

# =====================================
SECTION "Install ParaView Plugin: Gadget Reader"
git clone https://github.com/jfavre/ParaViewGadgetPlugin $SRC_ROOT/ParaViewGadgetPlugin
mkdir $BUILD_ROOT/ParaViewGadgetPlugin
cd    $BUILD_ROOT/ParaViewGadgetPlugin

cmake -G Ninja \
    -DCMAKE_PREFIX_PATH=$PARAVIEW_INSTALL_DIR \
    -DCMAKE_INSTALL_PREFIX=$PARAVIEW_PLUGINS_DIR \
    $SRC_ROOT/ParaViewGadgetPlugin
ninja install

# =====================================
SECTION "install helper scripts"
cp -r ${RECIPE}/helpers ${UENV_STORE}/

# =====================================
SECTION "cleanup"
rm -rf ${UENV_STORE}/temp

# =====================================
SECTION "Done"
