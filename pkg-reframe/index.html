
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../pkg-application-tutorial/">
      
      
        <link rel="next" href="../pkg-writing-docs/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>how to write reframe tests - alps-uenv</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.2a3383ac.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-orange" data-md-color-accent="deep-orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#reframe-testing-tutorial" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="alps-uenv" class="md-header__button md-logo" aria-label="alps-uenv" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            alps-uenv
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              how to write reframe tests
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/eth-cscs/alps-uenv" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../uenv-overview/" class="md-tabs__link">
          
  
  
  uenv

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../developers-overview/" class="md-tabs__link">
          
  
  
  developers

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../tutorial-overview/" class="md-tabs__link">
          
  
  
  tutorials

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="alps-uenv" class="md-nav__button md-logo" aria-label="alps-uenv" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    alps-uenv
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/eth-cscs/alps-uenv" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    uenv
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            uenv
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../uenv-overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    uenv
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../uenv-cp2k/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    cp2k
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../uenv-editors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    editors
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../uenv-gromacs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    gromacs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../uenv-lammps/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    lammps
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../uenv-linaro-forge/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    linaro-forge
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../uenv-namd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    namd
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../uenv-prgenv-gnu/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    prgenv-gnu
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../uenv-prgenv-nvfortran/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    prgenv-nvfortran
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../uenv-qe/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantumespresso
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../uenv-vasp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    vasp
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    developers
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            developers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../developers-overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    developers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pkg-application-tutorial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    recipe writing best practices
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    how to write reframe tests
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    how to write reframe tests
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-uenv-reframe-testing-works" class="md-nav__link">
    <span class="md-ellipsis">
      How uenv ReFrame testing works
    </span>
  </a>
  
    <nav class="md-nav" aria-label="How uenv ReFrame testing works">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uenv-recipe-meta-data" class="md-nav__link">
    <span class="md-ellipsis">
      uenv recipe meta data
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-uenv-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Creating uenv tests
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Creating uenv tests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-create-a-reframeyaml-file" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: create a reframe.yaml file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-set-up-the-cscs-reframe-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2: set up the CSCS reframe tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-up-reframe" class="md-nav__link">
    <span class="md-ellipsis">
      Set up ReFrame
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-up-the-reframe-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Set up the ReFrame tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#addingupdating-tests-to-a-uenv" class="md-nav__link">
    <span class="md-ellipsis">
      Adding/updating tests to a uenv
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Adding/updating tests to a uenv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-building-the-software" class="md-nav__link">
    <span class="md-ellipsis">
      Test: building the software
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-run-the-unit-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Test: run the unit tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-single-gpu-benchmark" class="md-nav__link">
    <span class="md-ellipsis">
      Test: single GPU benchmark
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-mpi-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Test: MPI tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Running tests
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pkg-writing-docs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    writing uenv documentation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial-overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    tutorials
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial-spack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    uenv and Spack
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial-userday-2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CSCS user day 2024
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-uenv-reframe-testing-works" class="md-nav__link">
    <span class="md-ellipsis">
      How uenv ReFrame testing works
    </span>
  </a>
  
    <nav class="md-nav" aria-label="How uenv ReFrame testing works">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uenv-recipe-meta-data" class="md-nav__link">
    <span class="md-ellipsis">
      uenv recipe meta data
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-uenv-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Creating uenv tests
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Creating uenv tests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-create-a-reframeyaml-file" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: create a reframe.yaml file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-set-up-the-cscs-reframe-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2: set up the CSCS reframe tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-up-reframe" class="md-nav__link">
    <span class="md-ellipsis">
      Set up ReFrame
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-up-the-reframe-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Set up the ReFrame tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#addingupdating-tests-to-a-uenv" class="md-nav__link">
    <span class="md-ellipsis">
      Adding/updating tests to a uenv
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Adding/updating tests to a uenv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-building-the-software" class="md-nav__link">
    <span class="md-ellipsis">
      Test: building the software
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-run-the-unit-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Test: run the unit tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-single-gpu-benchmark" class="md-nav__link">
    <span class="md-ellipsis">
      Test: single GPU benchmark
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-mpi-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Test: MPI tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Running tests
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="reframe-testing-tutorial">ReFrame Testing Tutorial<a class="headerlink" href="#reframe-testing-tutorial" title="Permanent link">&para;</a></h1>
<p>When <a href="https://reframe-hpc.readthedocs.io/en/stable/">ReFrame</a> tests are enabled for a uenv, they are automatically run:</p>
<ul>
<li>in the CI/CD pipeline after the image has been built;</li>
<li>in daily/weekly testing of individual vClusters;</li>
<li>and when upgrading and updating vClusters.</li>
</ul>
<p>This page is a tutorial that will guide you through the process of enabling testing for your uenv, and on writing portable tests that will run on any uenv-enabled system on <a href="https://www.cscs.ch/computers/alps">Alps</a>.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Currently this tutorial shows how to create and run tests for a uenv image that has already been created.</p>
<p>TODO:</p>
<ul>
<li>Describe how to add the test to the recipe and view the test results in the CI/CD pipeline</li>
</ul>
</div>
<h2 id="how-uenv-reframe-testing-works">How uenv ReFrame testing works<a class="headerlink" href="#how-uenv-reframe-testing-works" title="Permanent link">&para;</a></h2>
<p>CSCS maintains a set of <a href="https://reframe-hpc.readthedocs.io/en/stable/">ReFrame</a> tests in the CSCS ReFrame tests repository <a href="https://github.com/eth-cscs/cscs-reframe-tests">eth-cscs/cscs-reframe-tests</a>.
These tests cover a very wide range of features, including application tests, login node health and Slurm, and can be run on any vCluster on Alps.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>When running this test suite with a uenv, only the subset of the test suite that is relevant for the uenv will be run.</p>
</div>
<p>Setting up tests for a uenv requires making changes to two repositories:</p>
<ul>
<li><a href="https://github.com/eth-cscs/alps-uenv">eth-cscs/alps-uenv</a> <strong>adding metadata to the uenv</strong> to be used by ReFrame to:<ul>
<li>load the uenv and configure the environment so that it is ready to run tests;</li>
<li>and, choose which tests from the test suite are used to test the uenv.</li>
</ul>
</li>
<li><a href="https://github.com/eth-cscs/cscs-reframe-tests">eth-cscs/cscs-reframe-tests</a> <strong>updating and adding tests</strong> in the that are relevant to the uenv.<ul>
<li>might not be necessary if the tests already exist.</li>
</ul>
</li>
</ul>
<h3 id="uenv-recipe-meta-data">uenv recipe meta data<a class="headerlink" href="#uenv-recipe-meta-data" title="Permanent link">&para;</a></h3>
<p>To enable ReFrame tests in your uenv, a yaml file <code>extra/reframe.yaml</code> should be added to the recipe.</p>
<p>Below is an example <code>reframe.yaml</code> file:</p>
<div class="language-yaml highlight"><span class="filename">extra/reframe.yaml for testing a single environment provided by a uenv</span><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nt">develop</span><span class="p">:</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">  </span><span class="nt">features</span><span class="p">:</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cuda</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mpi</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arbor-dev</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">  </span><span class="nt">cc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mpicc</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">  </span><span class="nt">cxx</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mpic++</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">  </span><span class="nt">ftn</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mpifort</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">  </span><span class="nt">views</span><span class="p">:</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">develop</span>
</span></code></pre></div>
<p>This configuration defines a single <em>environment</em> named <code>develop</code>, which corresponds a <a href="https://reframe-hpc.readthedocs.io/en/stable/tutorial.html#environment-features-and-extras">ReFrame environment</a>, with some additions.</p>
<ul>
<li><code>features</code>: a list of ReFrame features that are provided by the environment.<ul>
<li>used to decide which tests will be run against the uenv.</li>
<li>in this case the uenv provides:<ul>
<li><code>cuda</code>: expect tests that compile and test NVIDIA GPU aware problems.</li>
<li><code>mpi</code>: expect basic MPI tests that compile and validate MPI to be run. When combined with <code>cuda</code> above, tests for GPU-aware MPI will be run.</li>
<li><code>arbor-dev</code>: a specific feature that specifies that <em>the environment provides everything required to build and run arbor</em>.</li>
</ul>
</li>
</ul>
</li>
<li><code>cc</code>, <code>cxx</code>, <code>ftn</code>: define the compiler aliases<ul>
<li>see the <a href="https://reframe-hpc.readthedocs.io/en/stable/tutorial.html#environment-features-and-extras">ReFrame environment</a>s documentation.</li>
</ul>
</li>
<li><code>views</code>: <strong>(optional)</strong> a list of views to load.<ul>
<li>in this case <code>develop</code> view is to be loaded.</li>
</ul>
</li>
</ul>
<p>A uenv can provide multiple views, for different use cases.
The most common example is a uenv that provides two views: one that provides an application, and another that provides the tools used to build the application. Another example is the <code>modules</code> and <code>spack</code> views, that expose a module interface or useful configuration for using Spack with the uenv.</p>
<p>Similarly, it is possible to create multiple environments to test.
The example below defines two environments that provide the same features, i.e. the same tests will be run on each.
The first example is the one above, and the second sets up an equivalent environment using modules.
This would be useful for a uenv that has some users who insist on using modules to set up their build environment.</p>
<div class="language-yaml highlight"><span class="filename">extra/reframe.yaml for multiple environments to test</span><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nt">develop</span><span class="p">:</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">  </span><span class="nt">features</span><span class="p">:</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cuda</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mpi</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arbor-dev</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">  </span><span class="nt">cc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mpicc</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">  </span><span class="nt">cxx</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mpic++</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">  </span><span class="nt">ftn</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mpifort</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">  </span><span class="nt">views</span><span class="p">:</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">develop</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="nt">modules</span><span class="p">:</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">  </span><span class="nt">features</span><span class="p">:</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cuda</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mpi</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">arbor-dev</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="w">  </span><span class="nt">cc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mpicc</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="w">  </span><span class="nt">cxx</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mpic++</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="w">  </span><span class="nt">ftn</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mpifort</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="w">  </span><span class="nt">views</span><span class="p">:</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modules</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="w">  </span><span class="nt">activation</span><span class="p">:</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">module load cuda cray-mpich cmake ninja fmt</span>
</span></code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>The <code>modules</code> environment uses an additional <code>activation</code> field, which is a series of commands
to run in the shell before running the tests. In this case, modules provided by the uenv are loaded.</p>
</div>
<div class="admonition question">
<p class="admonition-title">What is an environment?</p>
<p>What is the difference between using <code>module load</code>, activating a python venv, loading a Spack environment, or a uenv view?</p>
<p>Nothing!</p>
<p>They all do the same thing - set environment variables.</p>
<p>The main variables that change the behavior of the system are <code>PATH</code> and <code>LD_LIBRARY_PATH</code>, though there are many others like <code>PKG_CONFIG_PATH</code>, <code>CUDA_HOME</code>, <code>MODULEPATH</code> etc that will have more subtle effects on configuring and building software.</p>
<p>Configuring an environment for running tests requires specifying the commands that will <strong>modify and set environment variables</strong> such that the tests can run. For example, a view or module might be loaded to make the executable of a scientific code be in <code>PATH</code>, or to add tools like <code>cmake</code>, <code>nvcc</code> and <code>gcc</code> to <code>PATH</code> so that we can run a test that builds an application.</p>
</div>
<h2 id="creating-uenv-tests">Creating uenv tests<a class="headerlink" href="#creating-uenv-tests" title="Permanent link">&para;</a></h2>
<p>The final objective for adding tests to a uenv is to have:</p>
<ol>
<li>a uenv deployed with an <code>extra/reframe.yaml</code> file;</li>
<li>and tests in the <a href="https://github.com/eth-cscs/cscs-reframe-tests">eth-cscs/cscs-reframe-tests</a> repository</li>
</ol>
<p>In this second half of the tutorial, a workflow for doing this that minimises the amount of time spent
waiting in job and CI/CD queues is provided.
Before starting, you will need the following:</p>
<ul>
<li>a working uenv squashfs image with corresponding meta data path;</li>
<li>and a list of which tests you want to run against the uenv (some of which you have yet to write).</li>
</ul>
<h3 id="step-1-create-a-reframeyaml-file">Step 1: create a reframe.yaml file<a class="headerlink" href="#step-1-create-a-reframeyaml-file" title="Permanent link">&para;</a></h3>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># pull the image that you want to start developing tests for, e.g.:</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>$<span class="w"> </span>uenv<span class="w"> </span>image<span class="w"> </span>pull<span class="w"> </span>cp2k/2024.2:v1
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="c1"># get the meta data path</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>$<span class="w"> </span><span class="nv">meta</span><span class="o">=</span><span class="k">$(</span>uenv<span class="w"> </span>image<span class="w"> </span>inspect<span class="w"> </span>cp2k/2024.2:v1<span class="w"> </span>--format<span class="o">={</span>meta<span class="o">}</span><span class="k">)</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="c1"># check the path - your location will be different</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="si">${</span><span class="nv">meta</span><span class="si">}</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="c1"># create the reframe meta data file</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>$<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="si">${</span><span class="nv">meta</span><span class="si">}</span>/extra
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>$<span class="w"> </span>vim<span class="w"> </span><span class="si">${</span><span class="nv">meta</span><span class="si">}</span>/extra/reframe.yaml
</span></code></pre></div>
<p>The <code>meta</code> path is the metadata for the uenv for the image.</p>
<details class="note">
<summary>why create reframe.yaml in this location?</summary>
<p>We inject the <code>reframe.yaml</code> file into the meta data in the uenv repo to create a "development environment", where it can be modified while developing the tests in an interactive shell.</p>
<p>The <code>reframe.yaml</code> file will be added to the recipe later, once it is time to start testing in a CI/CD pipeline.</p>
</details>
<h3 id="step-2-set-up-the-cscs-reframe-tests">Step 2: set up the CSCS reframe tests<a class="headerlink" href="#step-2-set-up-the-cscs-reframe-tests" title="Permanent link">&para;</a></h3>
<p>The next step is to check out and setup ReFrame and the CSCS ReFrame test suite.</p>
<p>It might be a good idea to create a path for this work, and cloning the ReFrame and CSCS test suite repos as sub-directories.</p>
<h3 id="set-up-reframe">Set up ReFrame<a class="headerlink" href="#set-up-reframe" title="Permanent link">&para;</a></h3>
<p>The first step is to download and set up ReFrame:</p>
<ul>
<li>clone from <a href="https://github.com/reframe-hpc/reframe">ReFrame GitHub repository</a></li>
<li>run the bootstrap process that installs ReFrame's dependencies;</li>
<li>then add reframe to <code>PATH</code>.</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># clone from repo</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>git@github.com:reframe-hpc/reframe.git
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="c1"># run bootstrap process (only needs to be done once)</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>reframe
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>$<span class="w"> </span>./bootstrap.sh
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="c1"># add to PATH and verify that everything works</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PWD</span>/bin:<span class="nv">$PATH</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>$<span class="w"> </span>reframe<span class="w"> </span>--version
</span></code></pre></div>
<h3 id="set-up-the-reframe-tests">Set up the ReFrame tests<a class="headerlink" href="#set-up-the-reframe-tests" title="Permanent link">&para;</a></h3>
<p>The next step is to clone the CSCS test suite, and create a new branch where we will make any changes required to test our uenv.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># download the reframe tests</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>-b<span class="w"> </span>alps<span class="w"> </span>git@github.com:eth-cscs/cscs-reframe-tests.git
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>cscs-reframe-tests
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="c1"># start a branch for developing the tests (choose your own appropriate name)</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>git<span class="w"> </span>switch<span class="w"> </span>-c<span class="w"> </span>uenv-arbor
</span></code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Always create your working branch off of the <code>alps</code> branch.
The <code>alps</code> branch is used for tests run on Alps vClusters. It will become the main branch, once Piz Daint is decommisioned.</p>
</div>
<h2 id="addingupdating-tests-to-a-uenv">Adding/updating tests to a uenv<a class="headerlink" href="#addingupdating-tests-to-a-uenv" title="Permanent link">&para;</a></h2>
<p>Now everything is in place to implement the tests for your uenv, which will involve one or two of the following:</p>
<ol>
<li>add some new tests;</li>
<li>or, updating / porting existing tests that were written for the CPE+EasyBuild builds on Daint XC or Eiger.</li>
</ol>
<p>There are no existing tests for Arbor, so let's start by creating a path for the tests we will write:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a># create a path for the checks
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>mkdir checks/apps/arbor
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>cd checks/apps/arbor
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If there are existing tests, start editing the existing tests directly, or create a new test in that path.</p>
</div>
<p>In this tutorial we will write tests that:</p>
<ol>
<li>build Arbor, including unit tests and example miniapps</li>
<li>run Arbor's unit tests</li>
<li>run a benchmark with a single MPI rank on one GH200 GPU</li>
<li>run a benchmark with 4 ranks and 4 GPUs on a GH200 node.</li>
</ol>
<p><a href="https://github.com/eth-cscs/cscs-reframe-tests/tree/alps/checks/apps/arbor">Link to the tests</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These tests use the packages and tools in the uenv (CMake, cray-mpich, Python, cuda, etc) to build Arbor, then as runtime dependencies for running the Arbor tests.</p>
<p>If your uenv provides a pre-built application, you can skip building and use the executable directly to run validation and benchmark tests.</p>
</div>
<p>Here is a link to the tests for Arbor: <a href="https://github.com/eth-cscs/cscs-reframe-tests/blob/alps/checks/apps/arbor/arbor-dev.py"><code>checks/apps/arbor/arbor-dev.py</code></a>.</p>
<p>The modules <code>import</code>ed at the top of the file will depend on the ReFrame features used for the tests.
The <code>uenv</code> module is implemented in <a href="https://github.com/eth-cscs/cscs-reframe-tests/blob/alps/config/utilities/uenv.py"><code>config/utilities/uenv.py</code></a>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">uenv</span>
</span></code></pre></div>
<p>It provides the <code>uenv.uarch()</code> function, that will be used to determine the uenv
uarch (<code>gh200</code>, <code>a100</code>, <code>zen2</code>, etc.) of the system where tests are running.
We will see it in action below.</p>
<h3 id="test-building-the-software">Test: building the software<a class="headerlink" href="#test-building-the-software" title="Permanent link">&para;</a></h3>
<p>Building is handled by a test, in this case called <a href="https://github.com/eth-cscs/cscs-reframe-tests/blob/alps/checks/apps/arbor/arbor-dev.py#L47-L93"><code>arbor_build</code></a>, that derives from <code>rfm.CompileOnlyRegressionTest</code>.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Points of interest are annotated in the code below with <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 13h-4v4h-2v-4H7v-2h4V7h2v4h4m-5-9A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10A10 10 0 0 0 12 2"/></svg></span> symbols, click on them to expand.</p>
</div>
<div class="language-python annotate highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">arbor_build</span><span class="p">(</span><span class="n">rfm</span><span class="o">.</span><span class="n">CompileOnlyRegressionTest</span><span class="p">):</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>    <span class="n">descr</span> <span class="o">=</span> <span class="s1">&#39;Build Arbor&#39;</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>    <span class="n">valid_systems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>    <span class="n">valid_prog_environs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;+arbor-dev&#39;</span><span class="p">]</span> <span class="c1">#(1)</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>    <span class="n">build_system</span> <span class="o">=</span> <span class="s1">&#39;CMake&#39;</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>    <span class="n">sourcesdir</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>    <span class="n">maintainers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bcumming&#39;</span><span class="p">]</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>    <span class="n">arbor_sources</span> <span class="o">=</span> <span class="n">fixture</span><span class="p">(</span><span class="n">arbor_download</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span> <span class="c1">#(2)</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>    <span class="n">build_locally</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1">#(3)</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>    <span class="nd">@run_before</span><span class="p">(</span><span class="s1">&#39;compile&#39;</span><span class="p">)</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">uarch</span> <span class="o">=</span> <span class="n">uenv</span><span class="o">.</span><span class="n">uarch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_partition</span><span class="p">)</span> <span class="c1">#(4)</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">build_system</span><span class="o">.</span><span class="n">builddir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stagedir</span><span class="p">,</span> <span class="s1">&#39;build&#39;</span><span class="p">)</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>        <span class="n">tarball</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;v</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">arbor_sources</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s1">.tar.gz&#39;</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>        <span class="n">tarsource</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arbor_sources</span><span class="o">.</span><span class="n">stagedir</span><span class="p">,</span> <span class="n">tarball</span><span class="p">)</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prebuild_cmds</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>            <span class="sa">f</span><span class="s1">&#39;tar --strip-components=1 -xzf </span><span class="si">{</span><span class="n">tarsource</span><span class="si">}</span><span class="s1"> -C </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stagedir</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>        <span class="p">]</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">build_system</span><span class="o">.</span><span class="n">config_opts</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>            <span class="s1">&#39;-DARB_WITH_MPI=on&#39;</span><span class="p">,</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>            <span class="s1">&#39;-DARB_WITH_PYTHON=on&#39;</span><span class="p">,</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>        <span class="p">]</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>        <span class="c1"># set architecture-specific flags</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uarch</span> <span class="o">==</span> <span class="s1">&#39;gh200&#39;</span><span class="p">:</span> <span class="c1">#(5)</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">build_system</span><span class="o">.</span><span class="n">config_opts</span> <span class="o">+=</span> <span class="p">[</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>                <span class="s1">&#39;-DCMAKE_CUDA_ARCHITECTURES=90&#39;</span><span class="p">,</span>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>                <span class="s1">&#39;-DARB_GPU=cuda&#39;</span><span class="p">,</span>
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>            <span class="p">]</span>
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">uarch</span> <span class="o">==</span> <span class="s1">&#39;a100&#39;</span><span class="p">:</span>
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">build_system</span><span class="o">.</span><span class="n">config_opts</span> <span class="o">+=</span> <span class="p">[</span>
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>                <span class="s1">&#39;-DCMAKE_CUDA_ARCHITECTURES=80&#39;</span><span class="p">,</span>
</span><span id="__span-7-35"><a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>                <span class="s1">&#39;-DARB_GPU=cuda&#39;</span><span class="p">,</span>
</span><span id="__span-7-36"><a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>                <span class="s1">&#39;-DARB_VECTORIZE=on&#39;</span>
</span><span id="__span-7-37"><a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a>            <span class="p">]</span>
</span><span id="__span-7-38"><a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">uarch</span> <span class="o">==</span> <span class="s1">&#39;zen2&#39;</span><span class="p">:</span>
</span><span id="__span-7-39"><a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">build_system</span><span class="o">.</span><span class="n">config_opts</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;-DARB_VECTORIZE=on&#39;</span><span class="p">]</span>
</span><span id="__span-7-40"><a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a>
</span><span id="__span-7-41"><a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">build_system</span><span class="o">.</span><span class="n">max_concurrency</span> <span class="o">=</span> <span class="mi">64</span>
</span><span id="__span-7-42"><a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a>
</span><span id="__span-7-43"><a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">build_system</span><span class="o">.</span><span class="n">make_opts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pyarb&#39;</span><span class="p">,</span> <span class="s1">&#39;examples&#39;</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">]</span>
</span></code></pre></div>
<ol>
<li>Restrict this test to only run in environments that provide the <code>arbor-dev</code> feature.
    This can be a list of environments, e.g. <code>['+arbor-dev+cuda', '+python']</code> would run the test in environments that provide both <code>arbor-dev</code> and <code>cuda</code>, or environments that provide <code>python</code>.</li>
<li><code>arbor_download</code> is a <a href="https://reframe-hpc.readthedocs.io/en/v4.5.0/tutorial_fixtures.html">ReFrame fixture</a>, that handles downloading the source for Arbor.</li>
<li>The build stage is performed on a compute node using a sbatch job.
    Required so that the environment is configured properly, by adding the
    correct flags to the script:
    <div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>#SBATCH --uenv=...
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>#SBATCH --view=...
</span></code></pre></div></li>
<li>Determine the uarch of the nodes in the current partition, which will be a string like <code>"gh200"</code>, <code>"a100"</code>, "<code>zen2</code>", etc.</li>
<li>Use the uarch to set node-specific flags.</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>At no point do we mention specific cluster names or partitions.
This is different from how tests were written for Daint and Eiger in the past, where the test would
include explicit mentions of systems:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_system</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;daint&#39;</span><span class="p">,</span> <span class="s1">&#39;dom&#39;</span><span class="p">]:</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>  <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks</span> <span class="o">=</span> <span class="mi">576</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>  <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks_per_node</span> <span class="o">=</span> <span class="mi">36</span>
</span></code></pre></div>
<p>The new approach of parameterising over uarch means that the test can be configured for <em>any</em> vCluster with gh200 nodes.</p>
</div>
<h3 id="test-run-the-unit-tests">Test: run the unit tests<a class="headerlink" href="#test-run-the-unit-tests" title="Permanent link">&para;</a></h3>
<p>The C++ Arbor library provides GoogleTest unit tests that are bundled in a single executable <code>unit</code>.
The tests are not MPI enabled, and take less than 30 seconds to run 1000 individual tests.
As such, they are a good quick test!</p>
<div class="language-python annotate highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nd">@rfm</span><span class="o">.</span><span class="n">simple_test</span> <span class="c1">#(1)</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">arbor_unit</span><span class="p">(</span><span class="n">rfm</span><span class="o">.</span><span class="n">RunOnlyRegressionTest</span><span class="p">):</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>    <span class="n">descr</span> <span class="o">=</span> <span class="s1">&#39;Run the arbor unit tests&#39;</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span class="n">valid_systems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>    <span class="n">valid_prog_environs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;+arbor-dev&#39;</span><span class="p">]</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>    <span class="n">time_limit</span> <span class="o">=</span> <span class="s1">&#39;5m&#39;</span> <span class="c1">#(2)</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>    <span class="n">maintainers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bcumming&#39;</span><span class="p">]</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>    <span class="n">arbor_build</span> <span class="o">=</span> <span class="n">fixture</span><span class="p">(</span><span class="n">arbor_build</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;environment&#39;</span><span class="p">)</span> <span class="c1">#(3)</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>    <span class="nd">@run_before</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">)</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arbor_build</span><span class="o">.</span><span class="n">stagedir</span><span class="p">,</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>                                       <span class="s1">&#39;build&#39;</span><span class="p">,</span> <span class="s1">&#39;bin&#39;</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">)</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">executable_opts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>    <span class="nd">@sanity_function</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>        <span class="k">return</span> <span class="n">sn</span><span class="o">.</span><span class="n">assert_found</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;PASSED&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span> <span class="c1">#(4)</span>
</span></code></pre></div>
<ol>
<li>This is the first time that we have added an annotation to a test.
    This is a "leaf" in our set of test dependencies, run after the download
    and build stages that are its dependencies have run.</li>
<li>The unit tests run quickly - so set a short time limit for higher priority queuing</li>
<li>The <code>arbor_build</code> stage has to be run before this test, to build the unit tests.</li>
<li>Just check that the tests passed - performance checks are implemented elsewhere</li>
</ol>
<h3 id="test-single-gpu-benchmark">Test: single GPU benchmark<a class="headerlink" href="#test-single-gpu-benchmark" title="Permanent link">&para;</a></h3>
<p>Use the <code>miniring</code> benchmark provided by Arbor to check both correctness and performance.</p>
<p>The tests will run the <code>busyring</code> test in two configurations on a single GPU: <code>small</code> and <code>medium</code> in this test.
A separate test (see later) will also run the <code>medium</code> module on 4 GPUs.</p>
<p>To test for performance, target performance values need to be provided.
We create reference target values, in a dictionary outside the test class, for the following reasons:</p>
<ul>
<li>To ensure that the tests can be run across <em>any</em> <code>cluster:partition</code> with supported uarch.</li>
<li>Splitting the reference data out in this way makes it simpler to add feaures like reading performance targets from file, and adding new targets for a new uarch without touching the test itself.</li>
</ul>
<div class="language-python annotate highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">arbor_references</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>    <span class="s1">&#39;gh200&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="c1">#(1)</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>        <span class="s1">&#39;serial&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>            <span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>                <span class="s1">&#39;time_run&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="mf">9.25</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">),</span> <span class="c1"># (2)</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>            <span class="p">},</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>            <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>                <span class="s1">&#39;time_run&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="mf">35.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">),</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>            <span class="p">}</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>        <span class="p">},</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>        <span class="s1">&#39;distributed&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>            <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>                <span class="s1">&#39;time_run&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="mf">9.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">),</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>            <span class="p">}</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>        <span class="p">},</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>    <span class="p">}</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="p">}</span>
</span></code></pre></div>
<ol>
<li>Currently, we only have Arbor performance targets for <code>gh200</code>, fields for <code>zen2</code> would be added for Eiger testing.</li>
<li>These are labelled reference targets. A link will be added when it is found in ReFrame's "documentation".</li>
</ol>
<p>The test itself:</p>
<div class="language-python annotate highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="nd">@rfm</span><span class="o">.</span><span class="n">simple_test</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">arbor_busyring</span><span class="p">(</span><span class="n">rfm</span><span class="o">.</span><span class="n">RunOnlyRegressionTest</span><span class="p">):</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="sd">    run the arbor busyring example in small and medium model configurations</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>    <span class="n">descr</span> <span class="o">=</span> <span class="s1">&#39;arbor busyring model&#39;</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>    <span class="n">valid_systems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>    <span class="n">valid_prog_environs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;+arbor-dev&#39;</span><span class="p">]</span> <span class="c1">#(1)</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>    <span class="n">maintainers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bcumming&#39;</span><span class="p">]</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>    <span class="n">model_size</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">([</span><span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">])</span> <span class="c1">#(2)</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>    <span class="n">arbor_build</span> <span class="o">=</span> <span class="n">fixture</span><span class="p">(</span><span class="n">arbor_build</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;environment&#39;</span><span class="p">)</span> <span class="c1">#(3)</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>    <span class="nd">@run_before</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">)</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arbor_build</span><span class="o">.</span><span class="n">stagedir</span><span class="p">,</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>                                       <span class="s1">&#39;build&#39;</span><span class="p">,</span> <span class="s1">&#39;bin&#39;</span><span class="p">,</span> <span class="s1">&#39;busyring&#39;</span><span class="p">)</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">executable_opts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;busyring-input-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_size</span><span class="si">}</span><span class="s1">.json&#39;</span><span class="p">]</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">uarch</span> <span class="o">=</span> <span class="n">uenv</span><span class="o">.</span><span class="n">uarch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_partition</span><span class="p">)</span> <span class="c1">#(4)</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uarch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uarch</span> <span class="ow">in</span> <span class="n">arbor_references</span><span class="p">):</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_partition</span><span class="o">.</span><span class="n">fullname</span><span class="p">:</span>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>                    <span class="n">arbor_references</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uarch</span><span class="p">][</span><span class="s1">&#39;serial&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">model_size</span><span class="p">]</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>            <span class="p">}</span>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>    <span class="nd">@sanity_function</span>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>        <span class="c1"># if the meters are printed, the simulation ran to completion</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a>        <span class="k">return</span> <span class="n">sn</span><span class="o">.</span><span class="n">assert_found</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;meter-total&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a>    <span class="nd">@performance_function</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">time_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a>        <span class="k">return</span> <span class="n">sn</span><span class="o">.</span><span class="n">extractsingle</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;model-run\s+(\S+)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
</span></code></pre></div>
<ol>
<li>Only run in environments that provide <code>arbor-dev</code></li>
<li>The model is parameterised on model size. In practice this means that ReFrame will run
   the test twice, once for each parameter.
   The value of the parameter can be accessed as <code>self.model_size</code>, see the <code>prepare_run</code> method below.</li>
<li>Requires the build stage.</li>
<li>
<p>Instead of explicitly listing performance targets for all possible
   <code>system:partition</code> combinations, set the reference targets to those for the uarch <em>of the current partition</em>.
   In other words - the performance target is set dynamically based on the architecture of the node,
   instead of being hard coded using if-else statements in the test itself.</p>
<ul>
<li><code>self.uarch</code> is one of the alps arch: <code>"gh200"</code>, <code>"zen2"</code>, <code>"a100"</code>, ... etc., or <code>None</code></li>
<li><code>self.current_partition.fullname</code> is the <code>vcluster:partition</code> string, for example <code>"daint:normal"</code> or <code>"todi:debug"</code>.</li>
</ul>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The test will still run, and the <code>time_run</code> results will still be reported, when <code>arbor_references</code>
does not provide values for the current uarch.
However, in such cases, no comparison is made and the test will pass.</p>
</div>
<h3 id="test-mpi-tests">Test: MPI tests<a class="headerlink" href="#test-mpi-tests" title="Permanent link">&para;</a></h3>
<div class="language-python annotate highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">slurm_config</span> <span class="o">=</span> <span class="p">{</span> <span class="c1">#(1)</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>    <span class="s1">&#39;gh200&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ranks&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;cores&quot;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span> <span class="s2">&quot;gpu&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>    <span class="s1">&#39;zen2&#39;</span><span class="p">:</span>  <span class="p">{</span><span class="s2">&quot;ranks&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;cores&quot;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span> <span class="s2">&quot;gpu&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="p">}</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="nd">@rfm</span><span class="o">.</span><span class="n">simple_test</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">arbor_busyring_mpi</span><span class="p">(</span><span class="n">arbor_busyring</span><span class="p">):</span> <span class="c1">#(2)</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="sd">    adapt the busyring test to check paralle MPI execution</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>    <span class="n">descr</span> <span class="o">=</span> <span class="s1">&#39;arbor busyring model MPI on a single node&#39;</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>    <span class="n">model_size</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">([</span><span class="s1">&#39;medium&#39;</span><span class="p">])</span> <span class="c1"># (3)</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>    <span class="nd">@run_before</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">)</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">uarch</span> <span class="o">=</span> <span class="n">uenv</span><span class="o">.</span><span class="n">uarch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_partition</span><span class="p">)</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arbor_build</span><span class="o">.</span><span class="n">stagedir</span><span class="p">,</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>                                       <span class="s1">&#39;build&#39;</span><span class="p">,</span> <span class="s1">&#39;bin&#39;</span><span class="p">,</span> <span class="s1">&#39;busyring&#39;</span><span class="p">)</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">executable_opts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;busyring-input-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_size</span><span class="si">}</span><span class="s1">.json&#39;</span><span class="p">]</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks</span> <span class="o">=</span> <span class="n">slurm_config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uarch</span><span class="p">][</span><span class="s2">&quot;ranks&quot;</span><span class="p">]</span> <span class="c1"># (4)</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_cpus_per_task</span> <span class="o">=</span> <span class="n">slurm_config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uarch</span><span class="p">][</span><span class="s2">&quot;cores&quot;</span><span class="p">]</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>        <span class="k">if</span> <span class="n">slurm_config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uarch</span><span class="p">][</span><span class="s2">&quot;gpu&quot;</span><span class="p">]:</span>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;--gpus-per-task=1&#39;</span><span class="p">]</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uarch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uarch</span> <span class="ow">in</span> <span class="n">arbor_references</span><span class="p">):</span> 
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="p">{</span> <span class="c1"># (5)</span>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_partition</span><span class="o">.</span><span class="n">fullname</span><span class="p">:</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>                    <span class="n">arbor_references</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uarch</span><span class="p">][</span><span class="s1">&#39;distributed&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">model_size</span><span class="p">]</span>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>            <span class="p">}</span>
</span></code></pre></div>
<ol>
<li>Store the slurm configuration outside the test, like we did for the performance targets</li>
<li>This test shares a lot with the basic <code>arbor_busyring</code> test - so inherit.
    This might be code stink in this case, but it is useful for showing how to use inheritance to refine tests.</li>
<li>Reduce the model size parameter to a single option <code>medium</code> (this overwrites the inherited parameter)</li>
<li>Parameterise the Slurm configuration (the <code>num_tasks</code>, <code>num_cpus_per_task</code> etc magic variables) on uarch.</li>
<li>Parameterise the performance target on uarch.</li>
</ol>
<h2 id="running-tests">Running tests<a class="headerlink" href="#running-tests" title="Permanent link">&para;</a></h2>
<p>To run the tests, the first thing to do is set an environment variable that will be used by the
test suite to configure the environment.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">UENV</span><span class="o">=</span>arbor/v0.9:v1
</span></code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Currently only a uenv label can be used, i.e. the image must have already been built and pulled
into a local uenv repository, that is via <code>uenv image pull</code> or <code>uenv image pull --build</code>.</p>
<p>We will update this feature to allow you to provide the path of the squashfs image.
It will be a hard requirement that the meta data path will be in the same path
as the <code>store.squashfs</code> file.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If the <code>UENV</code> variable is not set proprely, the <code>reframe.yaml</code> file can't be found and you will see an error:
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>ERROR: failed to load configuration: problem loading the metadata from &#39;extra/reframe.yaml&#39; 
</span></code></pre></div></p>
</div>
<p>To run the tests use the following commands:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1"># run the tests</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>$<span class="w"> </span>reframe<span class="w"> </span>-C<span class="w"> </span>cscs-reframe-tests/config/cscs.py<span class="w"> </span><span class="se">\</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">  </span>-c<span class="w"> </span>cscs-reframe-tests/checks/apps/arbor/<span class="w"> </span>--keep-stage-files<span class="w"> </span><span class="se">\</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">  </span>-r
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="c1"># perform a dry run of tests</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>$<span class="w"> </span>reframe<span class="w"> </span>-C<span class="w"> </span>cscs-reframe-tests/config/cscs.py<span class="w"> </span><span class="se">\</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">  </span>-c<span class="w"> </span>cscs-reframe-tests/checks/apps/arbor/<span class="w"> </span>--keep-stage-files<span class="w"> </span><span class="se">\</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">  </span>--dry-run
</span></code></pre></div>
<ul>
<li><code>-C</code>: the system configuration, here provided by the CSCS test suite</li>
<li><code>-c &lt;path&gt; -r</code>: the path containing checks to run. The <code>-r</code> flag will search recursively for tests in sub-directories<ul>
<li>in this case, only consider the arbor tests.</li>
<li><code>-c cscs-reframe-tests/checks</code> would search through all tests for tests that
  are compatible with the features provided by the environments in the <code>extra/reframe.yaml</code> file.</li>
</ul>
</li>
<li><code>--keep-stage-files</code>: this will keep all of the intermediate scripts and configuration<ul>
<li>stored in the <code>stage</code> sub-directory of the current path.</li>
<li>very useful for debugging problems with our tests.</li>
</ul>
</li>
<li><code>--dry-run</code>: generate all the stage files and scripts without running the tests.</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Use the <code>--dry-run</code> first, to inspect the generated job scripts and that there are no issues
in the code. Once everything looks good, remove the flag to run the tests (which would take longer).</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Look in the <code>stage</code> path that is created in the path where you called reframe for all
of the job scripts, build files, and results.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If ReFrame tests fail because of <code>ReqNodesNotAvail</code> and you think it is a fluke, try setting
<code>RFM_IGNORE_REQNODENOTAVAIL=y</code>.</p>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "navigation.tabs"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>